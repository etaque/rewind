#!/usr/bin/env bash
set -euo pipefail

cd "$(dirname "$0")/../.."

AWS_PROFILE="rewind-terraform"
AWS_REGION="eu-west-3"

# Get Terraform outputs
get_tf_output() {
  terraform -chdir=infra output -raw "$1" 2>/dev/null
}

case "${1:-}" in
  push)
    echo "Building and pushing Docker image to ECR..."

    ECR_URL=$(get_tf_output ecr_repository_url)
    if [ -z "$ECR_URL" ]; then
      echo "Error: Could not get ECR URL. Run 'terraform apply' in infra/ first."
      exit 1
    fi

    echo "ECR Repository: $ECR_URL"

    # Authenticate Docker to ECR
    echo "Authenticating with ECR..."
    aws ecr get-login-password --region "$AWS_REGION" --profile "$AWS_PROFILE" | \
      docker login --username AWS --password-stdin "$ECR_URL"

    # Build and push
    echo "Building Docker image..."
    docker build -t rewind server/

    echo "Tagging and pushing..."
    docker tag rewind:latest "$ECR_URL:latest"
    docker push "$ECR_URL:latest"

    echo "Done! Image pushed to $ECR_URL:latest"
    ;;

  run)
    echo "Running pull-gribs task on Fargate..."

    CLUSTER=$(get_tf_output ecs_cluster_name)
    TASK_DEF=$(get_tf_output pull_gribs_task_definition)

    if [ -z "$CLUSTER" ] || [ -z "$TASK_DEF" ]; then
      echo "Error: Could not get ECS outputs. Run 'terraform apply' in infra/ first."
      exit 1
    fi

    # Get network configuration
    VPC_ID=$(aws ec2 describe-vpcs --profile "$AWS_PROFILE" --region "$AWS_REGION" \
      --filters "Name=isDefault,Values=true" --query "Vpcs[0].VpcId" --output text)

    SUBNETS=$(aws ec2 describe-subnets --profile "$AWS_PROFILE" --region "$AWS_REGION" \
      --filters "Name=vpc-id,Values=$VPC_ID" --query "Subnets[*].SubnetId" --output text | tr '\t' ',')

    SG_ID=$(aws ec2 describe-security-groups --profile "$AWS_PROFILE" --region "$AWS_REGION" \
      --filters "Name=group-name,Values=rewind-ecs-task" --query "SecurityGroups[0].GroupId" --output text)

    echo "Cluster: $CLUSTER"
    echo "Task Definition: $TASK_DEF"
    echo "Security Group: $SG_ID"

    # Run the task
    TASK_ARN=$(aws ecs run-task \
      --profile "$AWS_PROFILE" \
      --region "$AWS_REGION" \
      --cluster "$CLUSTER" \
      --task-definition "$TASK_DEF" \
      --launch-type FARGATE \
      --network-configuration "awsvpcConfiguration={subnets=[$SUBNETS],securityGroups=[$SG_ID],assignPublicIp=ENABLED}" \
      --query "tasks[0].taskArn" \
      --output text)

    echo "Task started: $TASK_ARN"
    echo ""
    echo "View logs with: ./server/bin/fargate logs"
    echo "Or in AWS Console: https://$AWS_REGION.console.aws.amazon.com/ecs/v2/clusters/$CLUSTER/tasks"
    ;;

  logs)
    echo "Tailing CloudWatch logs for pull-gribs..."

    LOG_GROUP="/ecs/rewind-pull-gribs"

    aws logs tail "$LOG_GROUP" \
      --profile "$AWS_PROFILE" \
      --region "$AWS_REGION" \
      --follow \
      --format short
    ;;

  status)
    echo "Checking running tasks..."

    CLUSTER=$(get_tf_output ecs_cluster_name)

    aws ecs list-tasks \
      --profile "$AWS_PROFILE" \
      --region "$AWS_REGION" \
      --cluster "$CLUSTER" \
      --query "taskArns" \
      --output table
    ;;

  *)
    echo "Usage: $0 {push|run|logs|status}"
    echo ""
    echo "Commands:"
    echo "  push    Build and push Docker image to ECR"
    echo "  run     Run the pull-gribs task on Fargate"
    echo "  logs    Tail CloudWatch logs"
    echo "  status  List running tasks"
    echo ""
    echo "First-time setup:"
    echo "  cd infra && terraform apply"
    echo "  ./server/bin/fargate push"
    echo "  ./server/bin/fargate run"
    exit 1
    ;;
esac
