#!/usr/bin/env bash
set -e

cd $(dirname "$0")/../..

case "$1" in
  up)
    echo "Starting containers..."
    docker compose up -d db martin
    echo "Waiting for database to be ready..."
    sleep 2
    docker compose exec db pg_isready -U rewind -d rewind
    echo "Containers are ready."
    echo ""
    echo "Run migrations with: cd server && cargo run -- db migrate"
    echo "Start server with:   cd server && ./bin/dev-server"
    ;;

  down)
    echo "Stopping containers..."
    docker compose down
    ;;

  logs)
    docker compose logs -f "${@:2}"
    ;;

  migrate)
    echo "Running migrations..."
    cd server && cargo run -- db migrate
    ;;

  reset)
    echo "Resetting database..."
    cd server && cargo run -- db reset
    ;;

  psql)
    docker compose exec db psql -U rewind -d rewind
    ;;

  destroy)
    echo "Destroying containers and volumes..."
    docker compose down -v
    ;;

  *)
    echo "Usage: $0 {up|down|logs|migrate|reset|psql|destroy}"
    echo ""
    echo "Commands:"
    echo "  up       Start database and martin containers"
    echo "  down     Stop all containers"
    echo "  logs     Follow container logs (optionally specify service)"
    echo "  migrate  Run database migrations"
    echo "  reset    Reset database tables"
    echo "  psql     Open PostgreSQL shell"
    echo "  destroy  Stop containers and remove volumes"
    exit 1
    ;;
esac
