#!/usr/bin/env bash
set -e

cd $(dirname "$0")/../..

case "$1" in
  up)
    echo "Starting containers..."
    docker compose up -d db minio
    echo "Waiting for database to be ready..."
    sleep 2
    docker compose exec db pg_isready -U rewind -d rewind
    echo "Initializing MinIO bucket..."
    docker compose up minio-init
    echo "Containers are ready."
    echo ""
    echo "Run migrations with: cd server && cargo run -- db migrate"
    echo "Start server with:   cd server && ./bin/dev-server"
    echo ""
    echo "MinIO Console: http://localhost:9001 (rewind/rewindpass)"
    echo "S3 Endpoint:   http://localhost:9000"
    ;;

  down)
    echo "Stopping containers..."
    docker compose down
    ;;

  logs)
    docker compose logs -f "${@:2}"
    ;;

  migrate)
    echo "Running migrations..."
    cd server && cargo run -- db migrate
    ;;

  reset)
    echo "Resetting database..."
    cd server && cargo run -- db reset
    ;;

  psql)
    pgcli postgres://rewind:rewind@127.0.0.1:25432/rewind
    ;;

  destroy)
    echo "Destroying containers and volumes..."
    docker compose down -v
    ;;

  minio)
    echo "Opening MinIO Console..."
    open http://localhost:9001 2>/dev/null || xdg-open http://localhost:9001 2>/dev/null || echo "Visit http://localhost:9001"
    ;;

  *)
    echo "Usage: $0 {up|down|logs|migrate|reset|psql|minio|destroy}"
    echo ""
    echo "Commands:"
    echo "  up       Start database and minio containers"
    echo "  down     Stop all containers"
    echo "  logs     Follow container logs (optionally specify service)"
    echo "  migrate  Run database migrations"
    echo "  reset    Reset database tables"
    echo "  psql     Open PostgreSQL shell"
    echo "  minio    Open MinIO console in browser"
    echo "  destroy  Stop containers and remove volumes"
    exit 1
    ;;
esac
