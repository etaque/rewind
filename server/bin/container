#!/usr/bin/env bash
set -e

cd $(dirname "$0")/../..

case "$1" in
  up)
    echo "Starting containers..."
    docker compose up -d
    echo "Waiting for database to be ready..."
    docker compose exec db pg_isready -U rewind -d rewind
    echo "Running migrations..."
    docker compose exec server rewind db migrate
    echo "Containers are ready."
    ;;

  down)
    echo "Stopping containers..."
    docker compose down
    ;;

  logs)
    docker compose logs -f "${@:2}"
    ;;

  migrate)
    echo "Running migrations..."
    docker compose exec server rewind db migrate
    ;;

  reset)
    echo "Resetting database..."
    docker compose exec server rewind db reset
    ;;

  build)
    echo "Building server image..."
    docker compose build server
    ;;

  shell)
    docker compose exec server /bin/bash
    ;;

  psql)
    docker compose exec db psql -U rewind -d rewind
    ;;

  destroy)
    echo "Destroying containers and volumes..."
    docker compose down -v
    ;;

  *)
    echo "Usage: $0 {up|down|logs|migrate|reset|build|shell|psql|destroy}"
    echo ""
    echo "Commands:"
    echo "  up       Start all containers and run migrations"
    echo "  down     Stop all containers"
    echo "  logs     Follow container logs (optionally specify service)"
    echo "  migrate  Run database migrations"
    echo "  reset    Reset database tables"
    echo "  build    Rebuild server image"
    echo "  shell    Open shell in server container"
    echo "  psql     Open PostgreSQL shell"
    echo "  destroy  Stop containers and remove volumes"
    exit 1
    ;;
esac
