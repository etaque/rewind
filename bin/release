#!/usr/bin/env bash
set -e
cd $(dirname "$0")/..

# Definitions

APP_NAME="rewind"
VERSION=$(git describe --abbrev=7 --dirty=-SNAPSHOT)
PACKAGE="$APP_NAME-$VERSION"
BRANCH=$(git rev-parse --abbrev-ref HEAD)

SERVER="rewind-prod"

# Commands

if [ "$1" == "local" ]; then

  make

  vagrant ssh -c "./bin/extract.sh packages/$PACKAGE.zip && ./bin/deploy.sh $PACKAGE"

elif [ "$1" == "upload" ]; then

  make clean
  sbt test
  make
  scp "target/universal/$PACKAGE.zip" "$SERVER:."
  ssh "$SERVER" "./bin/extract.sh $PACKAGE.zip"

elif [ "$1" == "deploy" ]; then

  ssh "$SERVER" "./bin/deploy.sh $PACKAGE"

else

  echo "Usage: $0 local|upload|deploy"
  exit 1

fi
