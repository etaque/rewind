#!/usr/bin/env bash
set -euo pipefail

cd "$(dirname "$0")/.."

AWS_PROFILE="${AWS_PROFILE:-rewind-frontend-uploader}"

# Set production server URL for build
export REWIND_SERVER_URL="https://rewind-api.fly.dev"

echo "Building client..."
npm run build

echo "Uploading to S3..."
aws s3 sync dist/ s3://rewind.milox.dev --delete --profile "$AWS_PROFILE"

DISTRIBUTION_ID=$(cd ../infra && terraform output -raw cloudfront_distribution_id)

echo "Invalidating CloudFront cache..."
aws cloudfront create-invalidation \
  --distribution-id "$DISTRIBUTION_ID" \
  --paths "/*" \
  --profile rewind-terraform \
  --output text

echo "Done!"
